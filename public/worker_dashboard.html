<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard brigádníka - Rychlé Rýče</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
</head>
<body>
    <!-- Navigační lišta -->
    <nav class="navbar navbar-expand-lg navbar-light bg-success">
        <div class="container">
            <a class="navbar-brand text-white fw-bold" href="/">
                <i class="fas fa-seedling me-2"></i>Rychlé Rýče
            </a>
            <div class="navbar-nav ms-auto">
                <span class="text-white me-3">Vítejte, <span id="user-name"></span>!</span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">Odhlásit se</button>
            </div>
        </div>
    </nav>

    <!-- Dashboard header -->
    <div class="bg-light py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-8">
                    <h2><i class="fas fa-hammer me-2 text-success"></i>Dashboard brigádníka</h2>
                    <p class="text-muted mb-0">Spravujte své zakázky a najděte novou práci</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <button class="btn btn-success me-2" onclick="loadAvailableOrders()">
                        <i class="fas fa-sync-alt me-2"></i>Obnovit
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Dashboard obsah -->
    <div class="container mt-4">
        <!-- Statistiky -->
        <div class="row g-4 mb-5">
            <div class="col-md-3">
                <div class="dashboard-card text-center">
                    <i class="fas fa-clipboard-list fa-2x text-info mb-2"></i>
                    <h4 id="available-count" class="mb-1">0</h4>
                    <p class="text-muted mb-0">Dostupné zakázky</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="dashboard-card text-center">
                    <i class="fas fa-cogs fa-2x text-warning mb-2"></i>
                    <h4 id="active-count" class="mb-1">0</h4>
                    <p class="text-muted mb-0">Aktivní zakázky</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="dashboard-card text-center">
                    <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                    <h4 id="completed-count" class="mb-1">0</h4>
                    <p class="text-muted mb-0">Dokončeno</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="dashboard-card text-center">
                    <i class="fas fa-euro-sign fa-2x text-primary mb-2"></i>
                    <h4 id="total-earned" class="mb-1">0 Kč</h4>
                    <p class="text-muted mb-0">Celkový výdělek</p>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4" id="workerTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="available-tab" data-bs-toggle="tab" data-bs-target="#available" type="button">
                    <i class="fas fa-search me-2"></i>Dostupné zakázky
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="my-orders-tab" data-bs-toggle="tab" data-bs-target="#my-orders" type="button">
                    <i class="fas fa-tasks me-2"></i>Moje zakázky
                </button>
            </li>
        </ul>

        <!-- Tab content -->
        <div class="tab-content" id="workerTabContent">
            <!-- Dostupné zakázky -->
            <div class="tab-pane fade show active" id="available" role="tabpanel">
                <div class="dashboard-card">
                    <h5 class="mb-4">
                        <i class="fas fa-clipboard-list me-2"></i>Dostupné zakázky
                    </h5>
                    <div id="available-orders-container">
                        <div class="loading">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p class="mt-3">Načítám dostupné zakázky...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Moje zakázky -->
            <div class="tab-pane fade" id="my-orders" role="tabpanel">
                <div class="dashboard-card">
                    <h5 class="mb-4">
                        <i class="fas fa-tasks me-2"></i>Moje zakázky
                    </h5>
                    <div id="my-orders-container">
                        <div class="loading">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p class="mt-3">Načítám vaše zakázky...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pro detail zakázky -->
    <div class="modal fade" id="orderDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-info-circle me-2"></i>Detail zakázky
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="order-detail-content">
                    <!-- Obsah se načte dynamicky -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="app.js"></script>
    <script>
        let availableOrders = [];
        let myOrders = [];

        // Inicializace při načtení stránky
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadAvailableOrders();
            loadMyOrders();
        });

        // Načtení dostupných zakázek
        async function loadAvailableOrders() {
            try {
                const response = await fetch('/api/available-orders');
                const data = await response.json();
                
                if (response.ok) {
                    availableOrders = data;
                    displayAvailableOrders();
                    updateStatistics();
                } else {
                    throw new Error(data.error || 'Chyba při načítání zakázek');
                }
            } catch (error) {
                console.error('Chyba při načítání dostupných zakázek:', error);
                document.getElementById('available-orders-container').innerHTML = `
                    <div class="text-center text-danger">
                        <i class="fas fa-exclamation-circle fa-2x mb-3"></i>
                        <p>Chyba při načítání dostupných zakázek</p>
                        <button class="btn btn-outline-success" onclick="loadAvailableOrders()">Zkusit znovu</button>
                    </div>
                `;
            }
        }

        // Načtení mých zakázek
        async function loadMyOrders() {
            try {
                const response = await fetch('/api/my-orders');
                const data = await response.json();
                
                if (response.ok) {
                    myOrders = data;
                    displayMyOrders();
                    updateStatistics();
                } else {
                    throw new Error(data.error || 'Chyba při načítání zakázek');
                }
            } catch (error) {
                console.error('Chyba při načítání mých zakázek:', error);
                document.getElementById('my-orders-container').innerHTML = `
                    <div class="text-center text-danger">
                        <i class="fas fa-exclamation-circle fa-2x mb-3"></i>
                        <p>Chyba při načítání vašich zakázek</p>
                        <button class="btn btn-outline-success" onclick="loadMyOrders()">Zkusit znovu</button>
                    </div>
                `;
            }
        }

        // Zobrazení dostupných zakázek
        function displayAvailableOrders() {
            const container = document.getElementById('available-orders-container');
            
            if (availableOrders.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-clipboard-list fa-3x mb-3"></i>
                        <h5>Žádné dostupné zakázky</h5>
                        <p>Momentálně nejsou k dispozici žádné nové zakázky.</p>
                        <button class="btn btn-outline-success" onclick="loadAvailableOrders()">
                            <i class="fas fa-sync-alt me-2"></i>Obnovit
                        </button>
                    </div>
                `;
                return;
            }

            let html = '';
            availableOrders.forEach(order => {
                const workType = translateWorkType(order.work_type);
                const date = formatDate(order.created_at);
                
                // Fotky
                let photosHtml = '';
                if (order.photos) {
                    const photos = order.photos.split(',');
                    photosHtml = photos.slice(0, 2).map(photo => 
                        `<img src="/uploads/${photo}" alt="Foto" style="width: 50px; height: 50px; object-fit: cover; margin-right: 5px; border-radius: 4px;">`
                    ).join('');
                    if (photos.length > 2) {
                        photosHtml += `<span class="badge bg-secondary">+${photos.length - 2}</span>`;
                    }
                }

                html += `
                    <div class="row mb-3 p-3 border rounded hover-shadow">
                        <div class="col-md-8">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="mb-0">${workType}</h6>
                                <span class="badge bg-warning">Nová zakázka</span>
                            </div>
                            <p class="text-muted mb-1">
                                <i class="fas fa-user me-1"></i>${order.customer_name}
                                ${order.customer_phone ? `<i class="fas fa-phone ms-3 me-1"></i>${order.customer_phone}` : ''}
                            </p>
                            <p class="text-muted mb-1"><i class="fas fa-map-marker-alt me-1"></i>${order.address}</p>
                            <p class="text-muted mb-1"><i class="fas fa-calendar me-1"></i>${date}</p>
                            ${order.description ? `<p class="mb-2"><small>${order.description.substring(0, 100)}${order.description.length > 100 ? '...' : ''}</small></p>` : ''}
                            ${photosHtml ? `<div class="mb-2">${photosHtml}</div>` : ''}
                            ${order.has_tools ? '<span class="badge bg-info me-2">Má vlastní nářadí</span>' : '<span class="badge bg-secondary me-2">Potřebuje nářadí</span>'}
                        </div>
                        <div class="col-md-4 text-md-end">
                            <h6 class="text-success mb-2">~${order.estimated_price} Kč</h6>
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-info btn-sm" onclick="showOrderDetail(${order.id}, 'available')">
                                    <i class="fas fa-eye me-1"></i>Detail
                                </button>
                                <button class="btn btn-success btn-sm" onclick="acceptOrder(${order.id})">
                                    <i class="fas fa-check me-1"></i>Přijmout
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Zobrazení mých zakázek
        function displayMyOrders() {
            const container = document.getElementById('my-orders-container');
            
            if (myOrders.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-tasks fa-3x mb-3"></i>
                        <h5>Žádné zakázky</h5>
                        <p>Zatím jste nepřijal žádné zakázky.</p>
                    </div>
                `;
                return;
            }

            let html = '';
            myOrders.forEach(order => {
                const workType = translateWorkType(order.work_type);
                const status = translateStatus(order.status);
                const statusClass = getStatusClass(order.status);
                const date = formatDate(order.created_at);
                
                // Hodnocení zákazníka
                let ratingHtml = '';
                if (order.rating) {
                    ratingHtml = `
                        <div class="mt-2">
                            <small class="text-muted">Hodnocení zákazníka:</small><br>
                            <div class="rating-stars">${createStarRating(order.rating)}</div>
                            ${order.feedback ? `<p class="small mt-1 mb-0">"${order.feedback}"</p>` : ''}
                        </div>
                    `;
                }

                // Akce
                let actionsHtml = '';
                if (order.status === 'accepted') {
                    actionsHtml = `
                        <button class="btn btn-success btn-sm" onclick="completeOrder(${order.id})">
                            <i class="fas fa-check-circle me-1"></i>Dokončeno
                        </button>
                    `;
                }

                html += `
                    <div class="row mb-3 p-3 border rounded">
                        <div class="col-md-8">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="mb-0">${workType}</h6>
                                <span class="status-badge ${statusClass}">${status}</span>
                            </div>
                            <p class="text-muted mb-1">
                                <i class="fas fa-user me-1"></i>${order.customer_name}
                                ${order.customer_phone ? `<i class="fas fa-phone ms-3 me-1"></i>${order.customer_phone}` : ''}
                            </p>
                            <p class="text-muted mb-1"><i class="fas fa-map-marker-alt me-1"></i>${order.address}</p>
                            <p class="text-muted mb-1"><i class="fas fa-calendar me-1"></i>${date}</p>
                            ${order.description ? `<p class="mb-2"><small>${order.description}</small></p>` : ''}
                            ${ratingHtml}
                        </div>
                        <div class="col-md-4 text-md-end">
                            <h6 class="text-success mb-2">~${order.estimated_price} Kč</h6>
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-info btn-sm" onclick="showOrderDetail(${order.id}, 'my')">
                                    <i class="fas fa-eye me-1"></i>Detail
                                </button>
                                ${actionsHtml}
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Aktualizace statistik
        function updateStatistics() {
            let completedCount = 0;
            let totalEarned = 0;

            myOrders.forEach(order => {
                if (order.status === 'completed') {
                    completedCount++;
                    totalEarned += order.estimated_price || 0;
                }
            });

            const activeCount = myOrders.filter(order => order.status === 'accepted').length;

            document.getElementById('available-count').textContent = availableOrders.length;
            document.getElementById('active-count').textContent = activeCount;
            document.getElementById('completed-count').textContent = completedCount;
            document.getElementById('total-earned').textContent = totalEarned.toLocaleString('cs-CZ') + ' Kč';
        }

        // Zobrazení detailu zakázky
        function showOrderDetail(orderId, type) {
            const orders = type === 'available' ? availableOrders : myOrders;
            const order = orders.find(o => o.id === orderId);
            
            if (!order) return;

            const workType = translateWorkType(order.work_type);
            const status = translateStatus(order.status);
            const date = formatDate(order.created_at);

            // Fotky
            let photosHtml = '';
            if (order.photos) {
                const photos = order.photos.split(',');
                photosHtml = `
                    <h6>Fotografie:</h6>
                    <div class="row g-2 mb-3">
                        ${photos.map(photo => 
                            `<div class="col-md-4">
                                <img src="/uploads/${photo}" alt="Foto" class="img-fluid rounded" style="max-height: 200px; object-fit: cover;">
                            </div>`
                        ).join('')}
                    </div>
                `;
            }

            const content = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Typ práce:</h6>
                        <p>${workType}</p>
                        
                        <h6>Status:</h6>
                        <p><span class="status-badge ${getStatusClass(order.status)}">${status}</span></p>
                        
                        <h6>Zákazník:</h6>
                        <p>${order.customer_name}</p>
                        
                        ${order.customer_phone ? `<h6>Telefon:</h6><p>${order.customer_phone}</p>` : ''}
                        
                        <h6>Datum vytvoření:</h6>
                        <p>${date}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Adresa:</h6>
                        <p>${order.address}</p>
                        
                        <h6>Odhadovaná cena:</h6>
                        <p class="text-success fw-bold">~${order.estimated_price} Kč</p>
                        
                        <h6>Nářadí:</h6>
                        <p>${order.has_tools ? '✅ Zákazník má vlastní nářadí' : '❌ Zákazník potřebuje nářadí'}</p>
                    </div>
                </div>
                
                ${order.description ? `<h6>Popis práce:</h6><p>${order.description}</p>` : ''}
                
                ${photosHtml}
                
                ${order.rating ? `
                    <h6>Hodnocení zákazníka:</h6>
                    <div class="rating-stars mb-2">${createStarRating(order.rating)}</div>
                    ${order.feedback ? `<p class="fst-italic">"${order.feedback}"</p>` : ''}
                ` : ''}
            `;

            document.getElementById('order-detail-content').innerHTML = content;
            const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
            modal.show();
        }

        // Přijetí zakázky
        async function acceptOrder(orderId) {
            if (!confirm('Opravdu chcete přijmout tuto zakázku?')) {
                return;
            }

            try {
                const response = await fetch(`/api/orders/${orderId}/accept`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification('Zakázka byla úspěšně přijata!', 'success');
                    loadAvailableOrders();
                    loadMyOrders();
                } else {
                    showNotification(result.error || 'Chyba při přijímání zakázky', 'danger');
                }
            } catch (error) {
                console.error('Chyba při přijímání zakázky:', error);
                showNotification('Chyba spojení se serverem', 'danger');
            }
        }

        // Dokončení zakázky
        async function completeOrder(orderId) {
            if (!confirm('Označit tuto zakázku jako dokončenou?')) {
                return;
            }

            try {
                const response = await fetch(`/api/orders/${orderId}/complete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification('Zakázka byla označena jako dokončená!', 'success');
                    loadMyOrders();
                } else {
                    showNotification(result.error || 'Chyba při dokončování zakázky', 'danger');
                }
            } catch (error) {
                console.error('Chyba při dokončování zakázky:', error);
                showNotification('Chyba spojení se serverem', 'danger');
            }
        }

        // Event listeners pro taby
        document.getElementById('available-tab').addEventListener('click', loadAvailableOrders);
        document.getElementById('my-orders-tab').addEventListener('click', loadMyOrders);
    </script>
</body>
</html>