<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard zákazníka - Rychlé Rýče</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
</head>
<body>
    <!-- Navigační lišta -->
    <nav class="navbar navbar-expand-lg navbar-light bg-success">
        <div class="container">
            <a class="navbar-brand text-white fw-bold" href="/">
                <i class="fas fa-seedling me-2"></i>Rychlé Rýče
            </a>
            <div class="navbar-nav ms-auto">
                <span class="text-white me-3">Vítejte, <span id="user-name"></span>!</span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">Odhlásit se</button>
            </div>
        </div>
    </nav>

    <!-- Dashboard header -->
    <div class="bg-light py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-8">
                    <h2><i class="fas fa-user-circle me-2 text-success"></i>Dashboard zákazníka</h2>
                    <p class="text-muted mb-0">Spravujte své objednávky zahradních služeb</p>
                </div>
                <div class="col-md-4 text-md-end">
                                            <a href="/" class="btn btn-success">
                            <i class="fas fa-plus me-2"></i>Vytvořit první objednávku
                        </a>
                    </div>
                `;
                return;
            }

            let html = '';
            filteredOrders.forEach(order => {
                const statusClass = getStatusClass(order.status);
                const workType = translateWorkType(order.work_type);
                const status = translateStatus(order.status);
                const date = formatDate(order.created_at);
                
                // Fotky
                let photosHtml = '';
                if (order.photos) {
                    const photos = order.photos.split(',');
                    photosHtml = photos.map(photo => 
                        `<img src="/uploads/${photo}" alt="Foto" style="width: 60px; height: 60px; object-fit: cover; margin-right: 5px; border-radius: 4px;">`
                    ).join('');
                }

                // Hodnocení
                let ratingHtml = '';
                if (order.rating) {
                    ratingHtml = `
                        <div class="mt-2">
                            <small class="text-muted">Vaše hodnocení:</small><br>
                            <div class="rating-stars">${createStarRating(order.rating)}</div>
                            ${order.feedback ? `<p class="small mt-1 mb-0">"${order.feedback}"</p>` : ''}
                        </div>
                    `;
                }

                // Informace o brigádníkovi
                let workerInfo = '';
                if (order.worker_name) {
                    workerInfo = `
                        <p class="mb-1"><strong>Brigádník:</strong> ${order.worker_name}</p>
                        ${order.worker_phone ? `<p class="mb-1"><strong>Telefon:</strong> ${order.worker_phone}</p>` : ''}
                    `;
                }

                // Akce
                let actionsHtml = '';
                if (order.status === 'completed' && !order.rating) {
                    actionsHtml = `
                        <button class="btn btn-warning btn-sm" onclick="openRatingModal(${order.id})">
                            <i class="fas fa-star me-1"></i>Hodnotit
                        </button>
                    `;
                }

                html += `
                    <div class="row mb-4 p-3 border rounded">
                        <div class="col-md-8">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="mb-0">${workType}</h6>
                                <span class="status-badge ${statusClass}">${status}</span>
                            </div>
                            <p class="text-muted mb-1"><i class="fas fa-map-marker-alt me-1"></i>${order.address}</p>
                            <p class="text-muted mb-1"><i class="fas fa-calendar me-1"></i>${date}</p>
                            ${order.description ? `<p class="mb-2"><strong>Popis:</strong> ${order.description}</p>` : ''}
                            ${workerInfo}
                            ${photosHtml ? `<div class="mb-2">${photosHtml}</div>` : ''}
                            ${ratingHtml}
                        </div>
                        <div class="col-md-4 text-md-end">
                            <h6 class="text-success mb-2">~${order.estimated_price} Kč</h6>
                            ${actionsHtml}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Aktualizace statistik
        function updateStatistics() {
            const stats = {
                pending: 0,
                accepted: 0,
                completed: 0,
                totalSpent: 0
            };

            orders.forEach(order => {
                switch(order.status) {
                    case 'pending':
                        stats.pending++;
                        break;
                    case 'accepted':
                        stats.accepted++;
                        break;
                    case 'completed':
                        stats.completed++;
                        stats.totalSpent += order.estimated_price || 0;
                        break;
                }
            });

            document.getElementById('pending-count').textContent = stats.pending;
            document.getElementById('accepted-count').textContent = stats.accepted;
            document.getElementById('completed-count').textContent = stats.completed;
            document.getElementById('total-spent').textContent = stats.totalSpent.toLocaleString('cs-CZ') + ' Kč';
        }

        // Aplikování filtrů
        function applyFilters() {
            const statusFilter = document.getElementById('status-filter').value;
            const workTypeFilter = document.getElementById('work-type-filter').value;
            const dateFromFilter = document.getElementById('date-from').value;

            filteredOrders = orders.filter(order => {
                // Filtr podle statusu
                if (statusFilter && order.status !== statusFilter) {
                    return false;
                }

                // Filtr podle typu práce
                if (workTypeFilter && order.work_type !== workTypeFilter) {
                    return false;
                }

                // Filtr podle data
                if (dateFromFilter) {
                    const orderDate = new Date(order.created_at);
                    const filterDate = new Date(dateFromFilter);
                    if (orderDate < filterDate) {
                        return false;
                    }
                }

                return true;
            });

            displayOrders();
        }

        // Otevření modalu pro hodnocení
        function openRatingModal(orderId) {
            document.getElementById('rating-order-id').value = orderId;
            const modal = new bootstrap.Modal(document.getElementById('ratingModal'));
            modal.show();
        }

        // Odeslání hodnocení
        async function submitRating() {
            const orderId = document.getElementById('rating-order-id').value;
            const rating = document.querySelector('input[name="rating"]:checked')?.value;
            const feedback = document.getElementById('feedback').value;

            if (!rating) {
                showNotification('Vyberte hodnocení', 'warning');
                return;
            }

            try {
                const response = await fetch(`/api/orders/${orderId}/rate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ rating: parseInt(rating), feedback })
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification('Hodnocení bylo odesláno', 'success');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('ratingModal'));
                    modal.hide();
                    
                    // Resetování formuláře
                    document.getElementById('ratingForm').reset();
                    
                    // Znovu načíst objednávky
                    loadOrders();
                } else {
                    showNotification(result.error || 'Chyba při odesílání hodnocení', 'danger');
                }
            } catch (error) {
                console.error('Chyba při odesílání hodnocení:', error);
                showNotification('Chyba spojení se serverem', 'danger');
            }
        }

        // Filtry s eventlistenery
        document.getElementById('status-filter').addEventListener('change', applyFilters);
        document.getElementById('work-type-filter').addEventListener('change', applyFilters);
        document.getElementById('date-from').addEventListener('change', applyFilters);
    </script>
</body>
</html>>
                        <i class="fas fa-plus me-2"></i>Nová objednávka
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard obsah -->
    <div class="container mt-4">
        <!-- Statistiky -->
        <div class="row g-4 mb-5">
            <div class="col-md-3">
                <div class="dashboard-card text-center">
                    <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                    <h4 id="pending-count" class="mb-1">0</h4>
                    <p class="text-muted mb-0">Čeká na přijetí</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="dashboard-card text-center">
                    <i class="fas fa-cogs fa-2x text-info mb-2"></i>
                    <h4 id="accepted-count" class="mb-1">0</h4>
                    <p class="text-muted mb-0">Probíhá</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="dashboard-card text-center">
                    <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                    <h4 id="completed-count" class="mb-1">0</h4>
                    <p class="text-muted mb-0">Dokončeno</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="dashboard-card text-center">
                    <i class="fas fa-euro-sign fa-2x text-primary mb-2"></i>
                    <h4 id="total-spent" class="mb-1">0 Kč</h4>
                    <p class="text-muted mb-0">Celkové náklady</p>
                </div>
            </div>
        </div>

        <!-- Filtry -->
        <div class="dashboard-card mb-4">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="status-filter" class="form-label">Status</label>
                    <select class="form-select" id="status-filter">
                        <option value="">Všechny</option>
                        <option value="pending">Čeká na přijetí</option>
                        <option value="accepted">Probíhá</option>
                        <option value="completed">Dokončeno</option>
                        <option value="cancelled">Zrušeno</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="work-type-filter" class="form-label">Typ práce</label>
                    <select class="form-select" id="work-type-filter">
                        <option value="">Všechny</option>
                        <option value="sekani_travy">Sekání trávy</option>
                        <option value="strhani_stromu">Stříhání stromů/keřů</option>
                        <option value="natrani_plotu">Natírání plotu</option>
                        <option value="jina_prace">Jiná práce</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="date-from" class="form-label">Od data</label>
                    <input type="date" class="form-control" id="date-from">
                </div>
                <div class="col-md-3">
                    <button class="btn btn-outline-success w-100" onclick="applyFilters()">
                        <i class="fas fa-filter me-2"></i>Filtrovat
                    </button>
                </div>
            </div>
        </div>

        <!-- Seznam objednávek -->
        <div class="dashboard-card">
            <h5 class="mb-4">
                <i class="fas fa-list-alt me-2"></i>Moje objednávky
            </h5>
            <div id="orders-container">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-3">Načítám objednávky...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pro hodnocení -->
    <div class="modal fade" id="ratingModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-star me-2 text-warning"></i>Hodnocení práce
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="ratingForm">
                        <input type="hidden" id="rating-order-id">
                        
                        <div class="mb-3 text-center">
                            <label class="form-label">Jak hodnotíte kvalitu práce?</label>
                            <div class="rating-input">
                                <input type="radio" id="star5" name="rating" value="5">
                                <label for="star5">⭐</label>
                                <input type="radio" id="star4" name="rating" value="4">
                                <label for="star4">⭐</label>
                                <input type="radio" id="star3" name="rating" value="3">
                                <label for="star3">⭐</label>
                                <input type="radio" id="star2" name="rating" value="2">
                                <label for="star2">⭐</label>
                                <input type="radio" id="star1" name="rating" value="1">
                                <label for="star1">⭐</label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="feedback" class="form-label">Zpětná vazba (nepovinné)</label>
                            <textarea class="form-control" id="feedback" name="feedback" rows="3" 
                                      placeholder="Napište svou zkušenost s brigádníkem..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zrušit</button>
                    <button type="button" class="btn btn-success" onclick="submitRating()">
                        <i class="fas fa-paper-plane me-2"></i>Odeslat hodnocení
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="app.js"></script>
    <script>
        let orders = [];
        let filteredOrders = [];

        // Inicializace při načtení stránky
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadOrders();
        });

        // Načtení objednávek
        async function loadOrders() {
            try {
                const response = await fetch('/api/my-orders');
                const data = await response.json();
                
                if (response.ok) {
                    orders = data;
                    filteredOrders = [...orders];
                    displayOrders();
                    updateStatistics();
                } else {
                    throw new Error(data.error || 'Chyba při načítání objednávek');
                }
            } catch (error) {
                console.error('Chyba při načítání objednávek:', error);
                document.getElementById('orders-container').innerHTML = `
                    <div class="text-center text-danger">
                        <i class="fas fa-exclamation-circle fa-2x mb-3"></i>
                        <p>Chyba při načítání objednávek</p>
                        <button class="btn btn-outline-success" onclick="loadOrders()">Zkusit znovu</button>
                    </div>
                `;
            }
        }

        // Zobrazení objednávek
        function displayOrders() {
            const container = document.getElementById('orders-container');
            
            if (filteredOrders.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-clipboard-list fa-3x mb-3"></i>
                        <h5>Žádné objednávky</h5>
                        <p>Zatím nemáte žádné objednávky zahradních služeb.</p>
                        <a href="/" class="btn btn-success